@page "/nominas/editar/{id}"
@using NominaSystem.UI.Models
@inject HttpClient Http
@inject Blazored.LocalStorage.ILocalStorageService LocalStorage
@inject NavigationManager Navigation
@inject IJSRuntime JS

<h3>Editar Nómina</h3>

<EditForm Model="nuevaNomina" OnValidSubmit="ActualizarNomina">
    <DataAnnotationsValidator />
    <ValidationSummary />

    <div class="mb-3">
        <label>Empleado:</label>
        <InputText class="form-control" @bind-Value="nuevaNomina.NombreEmpleado" readonly />
    </div>

    <div class="mb-3">
        <label>Salario Base:</label>
        <p class="form-control">@nuevaNomina.SalarioBase.ToString("F2")</p>
    </div>

    <div class="mb-3">
        <label>Periodo Inicio:</label>
        <InputDate class="form-control" @bind-Value="nuevaNomina.PeriodoInicio" />
    </div>

    <div class="mb-3">
        <label>Periodo Fin:</label>
        <InputDate class="form-control" @bind-Value="nuevaNomina.PeriodoFin" />
    </div>

    <div class="mb-3">
        <label>Horas Extras:</label>
        <InputNumber class="form-control" @bind-Value="nuevaNomina.HorasExtras" @oninput="RecalcularIGSSyTotal" />
    </div>

    <div class="mb-3">
        <label>Bonificaciones:</label>
        <InputNumber class="form-control" @bind-Value="nuevaNomina.Bonificaciones" @oninput="RecalcularIGSSyTotal" />
    </div>

    <div class="mb-3">
        <label>Descuentos:</label>
        <InputNumber class="form-control" @bind-Value="nuevaNomina.Descuentos" @oninput="RecalcularIGSSyTotal" />
    </div>

    <div class="mb-3">
        <label>Descuento IGSS (4.83%):</label>
        <p class="form-control">@nuevaNomina.IGSS.ToString("F2")</p>
    </div>

    <div class="mb-3">
        <label>Total Neto a Pagar:</label>
        <p class="form-control">@nuevaNomina.TotalPago.ToString("C")</p>
    </div>

    <div class="mt-4">
        <button type="submit" class="btn btn-success">Actualizar</button>
        <button type="button" class="btn btn-secondary" @onclick="Cancelar">Cancelar</button>
    </div>
</EditForm>

@code {
    private NominaDto nuevaNomina = new();
    [Parameter] public string Id { get; set; }

    protected override async Task OnInitializedAsync()
    {
        if (int.TryParse(Id, out var nominaId))
        {
            try
            {
                var token = await LocalStorage.GetItemAsync<string>("authToken");
                if (!string.IsNullOrEmpty(token))
                {
                    Http.DefaultRequestHeaders.Authorization =
                        new System.Net.Http.Headers.AuthenticationHeaderValue("Bearer", token);

                    var response = await Http.GetAsync($"api/Nomina/{nominaId}");
                    if (response.IsSuccessStatusCode)
                    {
                        nuevaNomina = await response.Content.ReadFromJsonAsync<NominaDto>();
                        RecalcularIGSSyTotal(); // Cálculo inicial
                    }
                    else
                    {
                        Console.WriteLine($"Error al obtener la nómina con ID {nominaId}. Código: {response.StatusCode}");
                    }
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error al cargar la nómina: {ex.Message}");
            }
        }
    }

    private void RecalcularIGSSyTotal()
    {
        if (nuevaNomina.SalarioBase > 0)
        {
            nuevaNomina.IGSS = Math.Round(nuevaNomina.SalarioBase * 0.0483m, 2);
        }
    }

    private async Task ActualizarNomina()
    {
        try
        {
            var response = await Http.PutAsJsonAsync($"api/Nomina/{nuevaNomina.Id}", nuevaNomina);
            if (!response.IsSuccessStatusCode)
            {
                Console.WriteLine($"Error al actualizar la nómina: {response.StatusCode}");
                return;
            }
            Navigation.NavigateTo("/nominas");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error al actualizar la nómina: {ex.Message}");
        }
    }

    private void Cancelar()
    {
        Navigation.NavigateTo("/nominas");
    }
}
