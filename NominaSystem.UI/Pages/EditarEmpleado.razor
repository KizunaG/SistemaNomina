@page "/empleados/editar/{id:int}"
@inject HttpClient Http
@inject NavigationManager Navigation
@using System.ComponentModel.DataAnnotations
@using System.Net.Http.Json

<h3>Editar Empleado</h3>

<EditForm Model="empleado" OnValidSubmit="GuardarCambios">
    <DataAnnotationsValidator />

    <div class="accordion" id="editarEmpleadoAccordion">

        <!-- Sección: Datos Generales -->
        <div class="accordion-item">
            <h2 class="accordion-header" id="headingGenerales">
                <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseGenerales" aria-expanded="true" aria-controls="collapseGenerales">
                    Datos Generales
                </button>
            </h2>
            <div id="collapseGenerales" class="accordion-collapse collapse show" aria-labelledby="headingGenerales" data-bs-parent="#editarEmpleadoAccordion">
                <div class="accordion-body">

                    <div class="mb-3">
                        <label>Nombre:</label>
                        <InputText class="form-control" @bind-Value="empleado.Nombre" />
                    </div>

                    <div class="mb-3">
                        <label>DPI:</label>
                        <InputText class="form-control" @bind-Value="empleado.Dpi" />
                    </div>

                    <div class="mb-3">
                        <label>Teléfono:</label>
                        <InputText class="form-control" @bind-Value="empleado.Telefono" />
                    </div>

                    <div class="mb-3">
                        <label>Estado Laboral:</label>
                        <InputSelect class="form-control" @bind-Value="empleado.EstadoLaboral">
                            <option value="">-- Seleccionar --</option>
                            <option value="Activo">Activo</option>
                            <option value="Inactivo">Inactivo</option>
                        </InputSelect>
                    </div>

                    <div class="mb-3">
                        <label>Dirección:</label>
                        <InputText class="form-control" @bind-Value="empleado.Direccion" />
                    </div>

                    <div class="mb-3">
                        <label>Fecha Ingreso:</label>
                        <InputDate class="form-control" @bind-Value="empleado.FechaIngreso" />
                    </div>

                    <div class="mb-3">
                        <label>Cargo:</label>
                        <InputSelect class="form-control" @bind-Value="empleado.Id_Cargo">
                            <option value="">-- Seleccione Cargo --</option>
                            @foreach (var c in cargos)
                            {
                                <option value="@c.Id">@c.NombreCargo</option>
                            }
                        </InputSelect>
                    </div>

                    <div class="mb-3">
                        <label>Departamento:</label>
                        <InputSelect class="form-control" @bind-Value="empleado.Id_Departamento">
                            <option value="">-- Seleccione Departamento --</option>
                            @foreach (var d in departamentos)
                            {
                                <option value="@d.Id">@d.NombreDepartamento</option>
                            }
                        </InputSelect>
                    </div>

                </div>
            </div>
        </div>

        <!-- Sección: Documentos -->
        <div class="accordion-item">
            <h2 class="accordion-header" id="headingDocumentos">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseDocumentos" aria-expanded="false" aria-controls="collapseDocumentos">
                    Documentos
                </button>
            </h2>
            <div id="collapseDocumentos" class="accordion-collapse collapse" aria-labelledby="headingDocumentos" data-bs-parent="#editarEmpleadoAccordion">
                <div class="accordion-body">

                    <div class="mb-3">
                        <label>Tipo Documento:</label>
                        <InputText class="form-control" @bind-Value="documento.TipoDocumento" />
                    </div>

                    <div class="mb-3">
                        <label>Ruta del Archivo:</label>
                        <InputText class="form-control" @bind-Value="documento.RutaArchivo" />
                    </div>

                    <div class="mb-3">
                        <label>Fecha de Entrega:</label>
                        <InputDate class="form-control" @bind-Value="documento.FechaEntrega" />
                    </div>

                </div>
            </div>
        </div>

        <!-- Sección: Historial Académico -->
        <div class="accordion-item">
            <h2 class="accordion-header" id="headingAcademico">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseAcademico" aria-expanded="false" aria-controls="collapseAcademico">
                    Historial Académico
                </button>
            </h2>
            <div id="collapseAcademico" class="accordion-collapse collapse" aria-labelledby="headingAcademico" data-bs-parent="#editarEmpleadoAccordion">
                <div class="accordion-body">

                    <div class="mb-3">
                        <label>Título:</label>
                        <InputText class="form-control" @bind-Value="academico.Titulo" />
                    </div>

                    <div class="mb-3">
                        <label>Institución:</label>
                        <InputText class="form-control" @bind-Value="academico.Institucion" />
                    </div>

                    <div class="mb-3">
                        <label>Grado Académico:</label>
                        <InputText class="form-control" @bind-Value="academico.GradoAcademico" />
                    </div>

                    <div class="mb-3">
                        <label>Fecha de Graduación:</label>
                        <InputDate class="form-control" @bind-Value="academico.FechaGraduacion" />
                    </div>

                </div>
            </div>
        </div>

    </div>

    <div class="mt-4">
        <button type="submit" class="btn btn-success">Guardar Cambios</button>
        <button type="button" class="btn btn-secondary" @onclick="Cancelar">Cancelar</button>
    </div>
</EditForm>

@code {
    [Parameter] public int id { get; set; }

    private Empleado empleado = new();
    private DocumentoDto documento = new();
    private InformacionAcademicaDto academico = new();

    private List<Cargo> cargos = new();
    private List<Departamento> departamentos = new();

    protected override async Task OnInitializedAsync()
    {
        // Cargar empleado a editar
        empleado = await Http.GetFromJsonAsync<Empleado>($"api/Empleados/{id}") ?? new Empleado();

        // Cargar documentos e info académica
        var docs = await Http.GetFromJsonAsync<List<DocumentoDto>>($"api/DocumentoEmpleado/por-empleado/{id}");
        documento = docs?.FirstOrDefault() ?? new DocumentoDto { ID_Empleado = id };

        var acad = await Http.GetFromJsonAsync<List<InformacionAcademicaDto>>($"api/InformacionAcademica/por-empleado/{id}");
        academico = acad?.FirstOrDefault(a => a.ID_Empleado == id) ?? new InformacionAcademicaDto { ID_Empleado = id };

        // Cargar listas para selects
        cargos = await Http.GetFromJsonAsync<List<Cargo>>("api/Cargos");
        departamentos = await Http.GetFromJsonAsync<List<Departamento>>("api/Departamentos");
    }

    private async Task GuardarCambios()
    {
        await Http.PutAsJsonAsync($"api/Empleados/{empleado.Id}", empleado);

        if (documento.Id > 0)
            await Http.PutAsJsonAsync($"api/DocumentoEmpleado/{documento.Id}", documento);
        else
            await Http.PostAsJsonAsync("api/DocumentoEmpleado", documento);

        if (academico.Id > 0)
            await Http.PutAsJsonAsync($"api/InformacionAcademica/{academico.Id}", academico);
        else
            await Http.PostAsJsonAsync("api/InformacionAcademica", academico);

        Navigation.NavigateTo("/empleados");
    }

    private void Cancelar() => Navigation.NavigateTo("/empleados");

    public class Empleado
    {
        public int Id { get; set; }
        public string Nombre { get; set; } = "";
        public string Dpi { get; set; } = "";
        public string Telefono { get; set; } = "";
        public string EstadoLaboral { get; set; } = "";
        public string Direccion { get; set; } = "";
        public DateTime FechaIngreso { get; set; }
        public int? Id_Cargo { get; set; }
        public int? Id_Departamento { get; set; }
    }

    public class DocumentoDto
    {
        public int Id { get; set; }
        public int ID_Empleado { get; set; }
        public string TipoDocumento { get; set; } = "";
        public string RutaArchivo { get; set; } = "";
        public DateTime? FechaEntrega { get; set; }
    }

    public class InformacionAcademicaDto
    {
        public int Id { get; set; }
        public int ID_Empleado { get; set; }
        public string Titulo { get; set; } = "";
        public string Institucion { get; set; } = "";
        public string GradoAcademico { get; set; } = "";
        public DateTime? FechaGraduacion { get; set; }
    }

    public class Cargo
    {
        public int Id { get; set; }
        public string NombreCargo { get; set; } = "";
    }

    public class Departamento
    {
        public int Id { get; set; }
        public string NombreDepartamento { get; set; } = "";
    }
}

