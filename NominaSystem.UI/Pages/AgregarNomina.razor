@page "/nominas/agregar"
@using NominaSystem.UI.Models
@inject HttpClient Http
@inject Blazored.LocalStorage.ILocalStorageService LocalStorage
@inject NavigationManager Navigation
@using System.ComponentModel.DataAnnotations

<h3>Agregar Nómina</h3>

<EditForm Model="nuevaNomina" OnValidSubmit="GuardarNomina">
    <DataAnnotationsValidator />

    <!-- Selección de Empleado -->
    <div class="mb-3">
        <label>Empleado:</label>
        <InputSelect class="form-control" @bind-Value="IdEmpleadoSeleccionado" TValue="int">
            <option value="">-- Seleccione Empleado --</option>
            @foreach (var e in empleados)
            {
                <option value="@e.Id">@e.Nombre</option>
            }
        </InputSelect>
        <ValidationMessage For="@(() => nuevaNomina.ID_Empleado)" class="text-danger" />
    </div>

    <div class="mb-3">
        <label>Salario Base:</label>
        <p class="form-control">@nuevaNomina.SalarioBase.ToString("F2")</p>
    </div>

    <div class="mb-3">
        <label>Periodo Inicio:</label>
        <InputDate class="form-control" @bind-Value="nuevaNomina.PeriodoInicio" />
        <ValidationMessage For="@(() => nuevaNomina.PeriodoInicio)" class="text-danger" />
    </div>

    <div class="mb-3">
        <label>Periodo Fin:</label>
        <InputDate class="form-control" @bind-Value="nuevaNomina.PeriodoFin" />
        <ValidationMessage For="@(() => nuevaNomina.PeriodoFin)" class="text-danger" />
    </div>

    <div class="mb-3">
        <label>Horas Extras:</label>
        <InputNumber class="form-control" @bind-Value="nuevaNomina.HorasExtras" />
        <ValidationMessage For="@(() => nuevaNomina.HorasExtras)" class="text-danger" />
    </div>

    <div class="mb-3">
        <label>Bonificaciones:</label>
        <InputNumber class="form-control" @bind-Value="nuevaNomina.Bonificaciones" />
        <ValidationMessage For="@(() => nuevaNomina.Bonificaciones)" class="text-danger" />
    </div>

    <div class="mb-3">
        <label>Descuentos:</label>
        <InputNumber class="form-control" @bind-Value="nuevaNomina.Descuentos" />
        <ValidationMessage For="@(() => nuevaNomina.Descuentos)" class="text-danger" />
    </div>

    <div class="mb-3">
        <label>Descuento IGSS (4.83%):</label>
        <p class="form-control">@nuevaNomina.IGSS.ToString("F2")</p>
    </div>

    <div class="mb-3">
        <label>Total Neto a Pagar:</label>
        <p class="form-control">@nuevaNomina.TotalPago.ToString("C")</p>
    </div>

    <div class="mt-4">
        <button type="submit" class="btn btn-success">Guardar</button>
        <button type="button" class="btn btn-secondary" @onclick="Cancelar">Cancelar</button>
    </div>
</EditForm>

@code {
    private NominaDto nuevaNomina = new();
    private List<EmpleadoDto> empleados = new();

    // 🔧 Propiedad para controlar selección del empleado y disparar lógica
    private int _idEmpleadoSeleccionado;
    private int IdEmpleadoSeleccionado
    {
        get => _idEmpleadoSeleccionado;
        set
        {
            _idEmpleadoSeleccionado = value;
            nuevaNomina.ID_Empleado = value;
            _ = ObtenerSalarioBase(); // llamada no esperada explícitamente
        }
    }

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var token = await LocalStorage.GetItemAsync<string>("authToken");
            if (!string.IsNullOrEmpty(token))
            {
                Http.DefaultRequestHeaders.Authorization =
                    new System.Net.Http.Headers.AuthenticationHeaderValue("Bearer", token);

                empleados = await Http.GetFromJsonAsync<List<EmpleadoDto>>("api/Empleados");
            }
            else
            {
                Console.WriteLine("Token no encontrado en LocalStorage");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error al cargar empleados: {ex.Message}");
        }
    }

    private async Task ObtenerSalarioBase()
    {
        if (nuevaNomina.ID_Empleado != 0)
        {
            try
            {
                var response = await Http.GetAsync($"api/nomina/empleado/{nuevaNomina.ID_Empleado}/salario");

                if (response.IsSuccessStatusCode)
                {
                    var salarioBase = await response.Content.ReadFromJsonAsync<decimal>();

                    Console.WriteLine($"✔ Salario recibido del API: {salarioBase}");

                    nuevaNomina.SalarioBase = salarioBase;
                    nuevaNomina.IGSS = Math.Round(salarioBase * 0.0483m, 2);

                    Console.WriteLine($"✔ IGSS calculado: {nuevaNomina.IGSS}");

                    await InvokeAsync(StateHasChanged);
                }
                else
                {
                    Console.WriteLine($"⚠ Error HTTP al obtener salario base: {response.StatusCode}");
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"❌ Excepción al obtener salario base: {ex.Message}");
            }
        }
    }

    private async Task GuardarNomina()
    {
        try
        {
            var response = await Http.PostAsJsonAsync("api/Nomina", nuevaNomina);
            if (!response.IsSuccessStatusCode)
            {
                Console.WriteLine($"Error al guardar nómina: {response.StatusCode}");
                return;
            }
            Navigation.NavigateTo("/nominas");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Excepción al guardar nómina: {ex.Message}");
        }
    }

    private void Cancelar()
    {
        Navigation.NavigateTo("/nominas");
    }
}










